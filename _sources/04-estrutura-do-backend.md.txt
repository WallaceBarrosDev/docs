# 4. Estrutura do Back-End

## 6.1 Explica√ß√£o n√£o t√©cnica

O backend √© a **‚Äúparte invis√≠vel‚Äù do sistema**, que roda no servidor e:

* Recebe os pedidos vindos do front-end (por exemplo: ‚Äúlistar itens‚Äù, ‚Äúsalvar formul√°rio‚Äù).
* Confere se o usu√°rio **pode** fazer aquela a√ß√£o (permiss√µes, login, regras).
* Conversa com:
  * o **banco interno** (dados pr√≥prios do sistema),
  * o **sistema local/externo** (API Local + DB Externo),
  * e o **cache** (para responder mais r√°pido).
* Junta todas essas informa√ß√µes, aplica as regras de neg√≥cio e devolve uma **resposta √∫nica e limpa** para o front-end, sempre passando pela **API interna**, nunca expondo diretamente o sistema externo.

Em resumo: o backend √© o **porteiro + recepcionista + analista** entre o front-end e os dados/sistemas internos/externos.

---

## 6.2 L√≥gica de Funcionamento do Back-End

O fluxo abaixo mostra, de forma simplificada, como uma requisi√ß√£o percorre o backend:

```{mermaid}
flowchart LR
    FE["üåê Frontend"] --> API["üîß API Interna"]
    API --> MW["üß± (logs, valida√ß√£o, auth)"]
    MW --> UC["üß† Servi√ßos / Casos de Uso"]
    
    UC --> Cache(("‚ö° Cache"))
    UC --> DBI(("üóÑÔ∏è DB Interno"))
    UC --> Bridge["üîó (API Externa)"]
    
    Bridge --> LocalAPI["üß© API Local"]
    LocalAPI --> DBE(("üóÑÔ∏è DB Externo"))

    DBI --> UC
    Cache --> UC
    DBE --> LocalAPI
    LocalAPI --> Bridge
    UC --> API
    API --> FE

%% Estilos padronizados (iguais aos diagramas da Arquitetura Geral)
classDef user fill:#f5f5f5,stroke:#333,color:#000;
classDef frontend fill:#61dafb,stroke:#333,color:#000;
classDef backend fill:#68a063,stroke:#333,color:#000;
classDef external fill:#4479a1,stroke:#333,color:#fff;
classDef db fill:#6c5ce7,stroke:#333,color:#fff;
classDef cache fill:#ff6b6b,stroke:#333,color:#000;
classDef auth fill:#fdd835,stroke:#333,color:#000;

class FE frontend;
class API,MW,UC,Bridge,LocalAPI backend;
class DBI,DBE db;
class Cache cache;
```

Passo a passo em linguagem simples:

O frontend chama a API Interna com uma requisi√ß√£o HTTP (GET/POST etc.).

A requisi√ß√£o passa por middlewares (logs, valida√ß√£o, autentica√ß√£o, autoriza√ß√£o).

A l√≥gica principal √© executada em Servi√ßos/Casos de Uso:

decide se precisa do banco interno, da API externa e/ou do cache;

aplica regras de neg√≥cio (ex.: ‚Äúse o usu√°rio for administrador, mostra X‚Äù).

Se precisar de dados externos, o caso de uso chama o DataBridge, que fala com a API Local e o DB Externo.

O que vier da API Local + DB Externo e do DB Interno √© transformado e unificado.

A resposta final (j√° sem detalhes internos) volta pela API Interna ‚Üí Frontend, em formato JSON.

## 6.3 Arquitetura Interna e Servi√ßos do Back-End

Abaixo est√° a vis√£o em camadas de como o backend √© organizado internamente:

```{mermaid}
graph TD

subgraph HTTP["Camada HTTP"]
    Routes["üõ£Ô∏è Rotas (Express)"]
    Controllers["üéõÔ∏è Controllers"]
    Middlewares["üß± M(auth, logs, valida√ß√£o)"]
end

subgraph Domain["Camada de Dom√≠nio"]
    Services["üß† Servi√ßos / Casos de Uso"]
    Validators["‚úîÔ∏è Validadores / Regras"]
end

subgraph Infra["Infraestrutura"]
    Repos["üìÇ Reposit√≥rios"]
    ExtClients["üîó Clientes Externos"]
    CacheProv["‚ö° Cache Provider"]
    Logger["üìú Logger"]
    Config["‚öôÔ∏è Config / Env"]
end

DBI[("üóÑÔ∏è DB Interno")]
DBE[("üóÑÔ∏è DB Externo")]
LocalAPI["üß© API Local"]

Routes --> Controllers
Controllers --> Middlewares
Middlewares --> Services

Services --> Validators
Services --> Repos
Services --> ExtClients
Services --> CacheProv

Repos --> DBI
ExtClients --> LocalAPI
LocalAPI --> DBE

%% Estilos padronizados
classDef frontend fill:#61dafb,stroke:#333,color:#000;
classDef backend fill:#68a063,stroke:#333,color:#000;
classDef external fill:#4479a1,stroke:#333,color:#fff;
classDef db fill:#6c5ce7,stroke:#333,color:#fff;
classDef cache fill:#ff6b6b,stroke:#333,color:#000;

class Routes,Controllers,Middlewares,Services,Validators,Repos,ExtClients,CacheProv,Logger,Config backend;
class LocalAPI external;
class DBI,DBE db;
```



## Camada de Dom√≠nio


Servi√ßos / Casos de Uso: cont√™m a regra de neg√≥cio (ex.: ‚Äúcriar pedido‚Äù, ‚Äúsincronizar dados externos‚Äù).

Validadores / Regras: encapsulam regras espec√≠ficas (ex.: valida√ß√£o de estado, limites, consist√™ncia).

## Infraestrutura

Reposit√≥rios: abstraem acesso ao DB Interno (queries, ORMs, etc.).

Clientes Externos (DataBridge, API Local): encapsulam requisi√ß√µes √† API Local e, por consequ√™ncia, ao DB Externo.

Cache Provider: cuida de leitura/escrita no cache (ex.: Redis ou similar).

Logger: centraliza logs estruturados e erros.

Config / Env: centraliza vari√°veis de ambiente, URLs, chaves, credenciais (sem espalhar process.env pelo c√≥digo).


## 6.4 Estrutura de C√≥digo do Back-End (Exemplo)


Abaixo, um modelo de organiza√ß√£o de pastas alinhado √† arquitetura acima (ajuste conforme sua stack real):

    backend/
    src/
    server.ts              # bootstrap do servidor HTTP (Express)
    config/                # configs, env, mapeamento de vari√°veis
      env.ts
      logger.ts
    modules/
      auth/
        http/
          controllers/
          routes.ts
          middlewares/
        services/
        repositories/
        dtos/
      sync/
        http/
          controllers/
          routes.ts
        services/
          SyncExternalDataService.ts
        repositories/
          InternalDataRepository.ts
        external/
          LocalApiClient.ts   # DataBridge p/ API Local
      shared/
        errors/
        utils/
    infra/
      http/
        app.ts              # instancia Express, aplica middlewares globais
      db/
        prisma/             # ou sequelize/typeorm/query builder
      cache/
        redisClient.ts
      external/
    httpClient.ts       # wrapper HTTP (axios/fetch) comum

## Ideias-chave dessa estrutura:

Cada m√≥dulo de dom√≠nio (auth, sync, etc.) agrupa seu pr√≥prio http/, services/, repositories/ etc.

A infra concentra detalhes tecnol√≥gicos (Express, ORM, Redis, HTTP client).

A camada de dom√≠nio (services, regras) n√£o ‚Äúconhece‚Äù detalhes de infraestrutura, apenas interfaces (repos, clients).
